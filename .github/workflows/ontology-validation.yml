name: Ontology Validation

on:
  push:
    paths:
      - 'design/ontology/**/*.ttl'
      - 'scripts/validate_ontology.py'
      - 'src/rust/ontology/**'
      - '.github/workflows/ontology-validation.yml'
  pull_request:
    paths:
      - 'design/ontology/**/*.ttl'
      - 'scripts/validate_ontology.py'
      - 'src/rust/ontology/**'

jobs:
  python-validation:
    name: Python Ontology Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Validate main ontology
        id: validate
        run: |
          python scripts/validate_ontology.py \
            --json validation-report.json \
            design/ontology/expanded-media-ontology.ttl
        continue-on-error: true

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: python-validation-report
          path: validation-report.json
          retention-days: 30

      - name: Check validation result
        run: |
          if [ -f validation-report.json ]; then
            echo "## Python Validation Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat validation-report.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          exit ${{ steps.validate.outcome == 'success' && 0 || 1 }}

  rust-validation:
    name: Rust Ontology Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build Rust validator
        working-directory: src/rust/ontology
        run: |
          cargo build --release

      - name: Run Rust validator tests
        working-directory: src/rust/ontology
        run: |
          cargo test --release

      - name: Run Rust validator on main ontology
        working-directory: src/rust/ontology
        run: |
          cargo run --release --example validate_ontology -- \
            ../../../design/ontology/expanded-media-ontology.ttl \
            --json rust-validation-report.json
        continue-on-error: true

      - name: Upload Rust validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rust-validation-report
          path: src/rust/ontology/rust-validation-report.json
          retention-days: 30

  test-broken-ontologies:
    name: Test Broken Ontologies Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Test broken ontologies
        run: |
          echo "Testing intentionally broken ontologies..."

          failed=0

          for ontology in tests/fixtures/broken_ontologies/*.ttl; do
            echo "Testing: $ontology"
            if python scripts/validate_ontology.py "$ontology"; then
              echo "ERROR: $ontology should have failed validation"
              failed=1
            else
              echo "✓ $ontology correctly detected as invalid"
            fi
          done

          if [ $failed -eq 1 ]; then
            echo "Some broken ontologies passed validation (test failure)"
            exit 1
          fi

          echo "All broken ontologies correctly rejected"

  compare-validators:
    name: Compare Python and Rust Validators
    runs-on: ubuntu-latest
    needs: [python-validation, rust-validation]
    if: always()

    steps:
      - name: Download Python report
        uses: actions/download-artifact@v4
        with:
          name: python-validation-report
          path: ./reports

      - name: Download Rust report
        uses: actions/download-artifact@v4
        with:
          name: rust-validation-report
          path: ./reports
        continue-on-error: true

      - name: Compare reports
        run: |
          echo "## Validator Comparison" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/validation-report.json ]; then
            python_errors=$(jq '.errors | length' reports/validation-report.json)
            python_warnings=$(jq '.warnings | length' reports/validation-report.json)
            echo "- **Python**: $python_errors errors, $python_warnings warnings" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f reports/rust-validation-report.json ]; then
            rust_errors=$(jq '.errors | length' reports/rust-validation-report.json)
            rust_warnings=$(jq '.warnings | length' reports/rust-validation-report.json)
            echo "- **Rust**: $rust_errors errors, $rust_warnings warnings" >> $GITHUB_STEP_SUMMARY
          fi

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [python-validation, rust-validation, test-broken-ontologies]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Ontology Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          python_status="${{ needs.python-validation.result }}"
          rust_status="${{ needs.rust-validation.result }}"
          broken_status="${{ needs.test-broken-ontologies.result }}"

          echo "| Validator | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python | $python_status |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust | $rust_status |" >> $GITHUB_STEP_SUMMARY
          echo "| Broken Ontologies Test | $broken_status |" >> $GITHUB_STEP_SUMMARY

          if [[ "$python_status" == "success" ]] && [[ "$rust_status" == "success" ]] && [[ "$broken_status" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All validations passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some validations failed. Review reports above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
